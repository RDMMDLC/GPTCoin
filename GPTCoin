#include <iostream>
#include <string>
#include <vector>
#include <ctime>
#include <sstream>
#include <iomanip>
#include <map>
#include <random>

using namespace std;

// Definición de la clase Transacción
class Transaccion {
private:
    string remitente;
    string destinatario;
    double cantidad;

public:
    Transaccion(string remitente, string destinatario, double cantidad);

    string getRemitente();
    string getDestinatario();
    double getCantidad();
};

// Constructor de la clase Transacción
Transaccion::Transaccion(string remitente, string destinatario, double cantidad) {
    this->remitente = remitente;
    this->destinatario = destinatario;
    this->cantidad = cantidad;
}

string Transaccion::getRemitente() {
    return this->remitente;
}

string Transaccion::getDestinatario() {
    return this->destinatario;
}

double Transaccion::getCantidad() {
    return this->cantidad;
}

// Definición de la clase Bloque
class Bloque {
private:
    int index;
    size_t hashAnterior;
    size_t hash;
    time_t tiempo;
    vector<Transaccion> transacciones;
    int dificultad;
    int nonce;

public:
    Bloque(int index, size_t hashAnterior, int dificultad);

    size_t calcularHash();
    void minarBloque();
    void agregarTransaccion(Transaccion transaccion);
    void mostrarTransacciones();
};

// Constructor de la clase Bloque
Bloque::Bloque(int index, size_t hashAnterior, int dificultad) {
    this->index = index;
    this->hashAnterior = hashAnterior;
    this->tiempo = time(nullptr);
    this->dificultad = dificultad;
    this->nonce = 0;
}

// Función que calcula el hash del bloque
size_t Bloque::calcularHash() {
    stringstream ss;
    ss << index << hashAnterior << tiempo << nonce;

    size_t hash = hash<string>{}(ss.str());

    for (int i = 0; i < transacciones.size(); i++) {
        hash ^= hash<string>{}(transacciones[i].getRemitente() + transacciones[i].getDestinatario() + to_string(transacciones[i].getCantidad()));
    }

    return hash;
}

// Función que realiza la minería del bloque
void Bloque::minarBloque() {
    vector<char> objetivo(dificultad + 1);
    objetivo[0] = '0';
    for (int i = 1; i < objetivo.size(); i++) {
        objetivo[i] = '0';
    }

    string hashCalculado = "";
    int intentos = 0;
    time_t inicio = time(nullptr);

    do {
        nonce++;
        hashCalculado = calcularHash();
        intentos++;
    } while (hashCalculado.substr(0, dificultad) != string(objetivo.begin(), objetivo.end()));

    time_t fin = time(nullptr);
    double tiempoTotal = difftime(fin, inicio);

    cout << "Bloque minado en " << fixed << setprecision(2) << tiempoTotal << " segundos. Hash: " << hashCalculado << endl;
    cout
